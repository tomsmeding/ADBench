\documentclass[11pt]{article}
\usepackage[a4paper,margin=2.5cm]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{microtype}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{mathtools}
\usepackage{hyperref}
\usepackage{parskip}
\usepackage{bm}
\usepackage{xcolor}
\usepackage{soul}

\newcommand\R{\mathbb R}
\newcommand\Z{\mathbb Z}
\newcommand\ra\rightarrow
\renewcommand\mod{\;\mathop{\mathrm{mod}}\;}
\let\oldepsilon\epsilon \let\epsilon\varepsilon \let\varepsilon\oldepsilon
\let\oldphi\phi \let\phi\varphi \let\varphi\oldphi
\let\oldemptyset\emptyset \let\emptyset\varnothing \let\varnothing\oldemptyset

\newcommand\logsumexp{\operatorname*{logsumexp}}
\newcommand\sumf{\operatorname*{sum}}
\newcommand\MultiGamma{\operatorname*{MultiGamma}}
\newcommand\append{\mathop{+\mkern-4mu+}}
\newcommand\flatten[1]{{(\rightsquigarrow\!#1)}}
\newcommand\precomptext[1]{\colorbox[rgb]{0.9,0.9,1}{#1}}
\newcommand\precomp[1]{\precomptext{$\displaystyle#1$}}


\begin{document}

\section{GMM: Gaussian Mixture Model fitting}

Given:
\begin{itemize}
\item $N, D, K \in \Z_{>0}$
\item $\bm{\alpha} = (\alpha_1,\ldots,\alpha_K) \in \R^K$
\item $\bm{M} = (\bm{\mu}_1,\ldots,\bm{\mu}_K) \in \R^{K \times D}$
\item $\bm{Q} = (\bm{q}_1,\ldots,\bm{q}_K) \in \R^{K \times D}$
\item $\bm{L} = (\bm{\ell}_1,\ldots,\bm{\ell}_K) \in \R^{K \times \frac{D(D-1)}{2}}$
\item $\bm{X} = (\bm{x}_1,\ldots,\bm{x}_N) \in \R^{N \times D}$
\item $\gamma \in \R$, $m \in \Z$
\end{itemize}

Objective: (\precomptext{highlighted} are \emph{scalar values} independent of varying parameters)
\begin{align*}
L(\bm{\alpha}, \bm{M}, \bm{Q}, \bm{L}) =
	&-\precomp{\tfrac12 N D \log(2\pi)} \\
	&+ \sum_{i=1}^N \logsumexp\left( \left[
		\alpha_k
		+ \sumf(\bm{q}_k)
		- \tfrac12\left\lVert
			Q(\bm{q}_k, \bm{\ell}_k) (\bm{x}_i - \bm{\mu}_k)
		\right\rVert^2
	\right]_{k=1}^K \right) \\
	&- \precomp{N} \cdot \logsumexp(\bm{\alpha}) \\
	&+ \sum_{k=1}^K \left(
		\precomp{\tfrac12 \gamma^2} \left(\lVert \exp(\bm{q}_k) \rVert^2 + \lVert \bm{l}_k \rVert^2\right)
		- \precomp{m} \cdot \sumf(\bm{q}_k)
	\right) \\
	&- \precomp{K \cdot \left( n' D \left(\log(\gamma) - \tfrac12\log(2)\right) - \log\MultiGamma\bigl(\tfrac12 n', D\bigr) \right)}
\end{align*}
where $n' = D + m + 1$, and $\logsumexp(\bm{x} : \R^n) = \log(\sumf(\exp(\bm{x} - \max(\bm{x})))) + \max(\bm{x})$, and:
\begin{align*}
Q(\bm{q}, \bm{\ell}) = \begin{bmatrix}
	\exp(q_1) & 0 & \cdots & 0 \\
	\ell_1 & \exp(q_2) & \cdots & 0 \\
	\vdots & \vdots & \ddots & \vdots \\
	\ell_{D-1} & \ell_{D-1+D-2} & \cdots & \exp(q_D)
\end{bmatrix}
\end{align*}
and $\log\MultiGamma$ is SciPy's \texttt{scipy.special.multigammaln}\footnote{\url{https://github.com/scipy/scipy/blob/7a7843bc1b54968ee99796333743c73608c0638d/scipy/special/spfun_stats.py}}, which can be defined by:
\begin{align*}
\log\MultiGamma(a, d)
&= \log \biggl( \pi^{d(d-1)/4} \prod_{i=1}^d \Gamma(a - (i-1)/2) \biggr) \\
&= \tfrac14 d(d-1) \log(\pi) + \sum_{i=1}^d \log\Gamma(a - (i-1)/2)
\end{align*}
and $\log\Gamma$ is generally implemented in \texttt{lgamma} for real arguments.


\newpage

\section{BA: Bundle Adjustment}

Input from file:
\begin{itemize}
\item $N, M, P \in \Z_{>0}$
\item $\mathit{onecam} \in \R^{11}$;
	$\mathit{onept} \in \R^3$;
	$w \in \R$;
	$\mathit{feat} \in \R^2$
\end{itemize}

Precompute the following:
\begin{itemize}
\item $\bm{C} \in \R^{n \times 11}$ ;
		$\bm{C}[i][..] = \mathit{onecam}$
\item $\bm{X} \in \R^{m \times 3}$ ;
		$\bm{X}[i][..] = \mathit{onept}$
\item $\bm{w} \in \R^p$ ;
		$\bm{w}[i] = w$
\item $\bm{F} \in \R^{p \times 2}$ ;
		$\bm{F}[i][..] = \mathit{feat}$
\item $\mathit{obs} \in \R^{p \times 2}$ ;
		$\mathit{obs}[i] = [((i - 1) \mod N) + 1, ((i - 1) \mod M) + 1]$
\end{itemize}

Define the following functions:
\begin{align*}
\mathrm{rodriguez}(\overset3{\bm{r}}, \overset3{\bm{x}}) &=
	\mathrm{\underline{let}}\ \theta = \lVert \bm{r} \rVert,
					\bm{v} = \bm{r} / \lVert \bm{r} \rVert \\
	&\phantom{=}\;\ \mathrm{\underline{in}}\ \bm{x} \cos \theta + (\bm{v} \times \bm{x}) \sin \theta + \bm{v} (\bm{v} \cdot \bm{x}) (1 - \cos \theta) \in \R^3 \\
\mathrm{rodriguez}(\overset3{\bm{r}}=[0,0,0], \overset3{\bm{x}}) &=
	\bm{x} + (\bm{r} \times \bm{x}) \\
\mathrm{p2e}(\overset3{\bm{x}}) &=
	[x_1 / x_3, x_2 / x_3] \in \R^2 \\
\mathrm{distort}(\overset2{\bm{\kappa}}, \overset2{\bm{u}}) &=
	\bm{u}(1 + \kappa_1 \lVert \bm{u} \rVert^2 + \kappa_2 \lVert \bm{u} \rVert^4) \in \R^2 \\
\mathrm{project}(\overset3{\bm{r}}, \overset3{\bm{c}}, \overset1f, \overset2{\bm{x}_0}, \overset2{\bm{\kappa}}, \overset3{\bm{x}}) &=
	\mathrm{distort}(\bm{\kappa}, \mathrm{p2e}(\mathrm{rodriguez}(\bm{r}, \bm{x} - \bm{c}))) f + \bm{x}_0 \in \R^2 \\
\mathrm{reprojerr}(\overset3{\bm{r}}, \overset3{\bm{c}}, \overset1f, \overset2{\bm{x}_0}, \overset2{\bm{\kappa}}, \overset3{\bm{x}}, \overset1w, \overset2{\bm{m}}) &=
	w(\bm{m} - \mathrm{project}(\bm{r}, \bm{c}, f, \bm{x}_0, \bm{\kappa}, \bm{x})) \in \R^2 \\
\mathrm{werr}(\overset1w) &=
	1 - w^2 \in \R
\end{align*}

Objective function:
\begin{align*}
&\mathrm{reproj\mathunderscore{}error} \in \R^{p \times 2} ; \\
&\mathrm{reproj\mathunderscore{}error}[i][..] = \mathrm{reprojerr}(\bm{C}[i][1..3], \bm{C}[i][4..6], \bm{C}[i][7], \bm{C}[i][8..9], \bm{C}[i][10..11], \bm{X}[i], \bm{w}[i], \bm{F}[i]) \\
&\mathrm{w\mathunderscore{}error} \in \R^p ;
\mathrm{w\mathunderscore{}error}[i] = \mathrm{werr}(\bm{w}[i])
\end{align*}

Jacobian matrix:
\begin{align*}
\mathrm{J} \in \R^{(2p + p) \times (11n + 3m + p)} ;\;
J[i][j] = \frac{\partial (\mathrm{reproj\mathunderscore{}error} \append \mathrm{w\mathunderscore{}error})_i}{\partial (\flatten{\bm{C}} \append \flatten{\bm{X}} \append \bm{w})_j}
\end{align*}
where $\flatten{\bm{C}}$ means to flatten $\bm{C}$ in row-major order.
For example, $\flatten{\bm{C}} \in \R^{11n}$ contains $n$ blocks of $11$ scalars.
This Jacobian is sparse, and to be represented in CSR format, where only entries that are statically known to be zero are omitted.
The \v{S}rajer paper shows a diagram of the sparsity pattern.


\end{document}
